<!DOCTYPE html>
<html>

<!-- Some Set Up things Here -->
    
<head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<title>All It Takes is a Simple Spreadsheet</title>
	<meta name="description" content="All It Takes is a Spreadsheet">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<link rel="stylesheet" type = "text/css" href="main.css"/>

</head>
    
    
<style>

		figure {
			position: relative;
			left: 25%;
			width: 50%;
			margin: 0;
			transform: translate3d(0, 0, 0);
			background-color: none ;
            overflow: hidden;
            text-align: center;
            z-index: 15;
		}
    
    img {
        position: relative;
			left: 50%;
			transform: translate3d(-50%, 0, 0);
        max-width: 75%;
        
    }
      

    
    
 </style>

<!-- Actually beginning to write out some stuff -->
    
<body>

               
<!-- Header -->
    <header id="header" style="background-color: rgb(252,252,252);">
		<!-- <img src="./images/logo.png" style="height: 70%; width:auto; margin-top: 20%" alt=""> </a> -->
		<a href="https://openingdata.github.io" class="logo" style="color: #1c1c1c;"><strong>Opening Data</strong> - Making Open Data Accessible</a>
		<!-- <nav>
					<a href="#menu">Menu</a>
				</nav> -->
    </header>
    
    
    
<section id="main">
        <div class="inner">
        
            <header>
					<h1 style="color: black;">All It Takes is a Spreadsheet </h1>
					<p class="info">October 10, 2019 <a href="github.com/sapowers"> Sam Powers </a></p>
            </header>
            
        
        
            <section>
            <center> <h3 style = 'color: black'> </h3></center>
                <p>
                In our piece on US Incarceration, we opened up a public dataset from the <a href = 'http://www.vera.org/'> Vera Institute of Justice</a> to explore the ealities of whom we confine. The simple, yet powerful, heatmap (replicated below) grounded our investigation. We like heatmaps because they force comparison. You cannot look at one square without exploring those around it. In a sense, all of the data here paints a picture of the US incarceration environment. And while you can still see granularity, you get something  deeper out of the sum of the parts. 
                </p>
            
            </section>
        </div>  
        
            <figure id = 'figure1'> </figure>   
        
        <section> 
        <div class="inner">      
            <section>
                <p>
                 But what if you stumble across a dataset that represents change across groups and time? What if you want to make comparisons on your own? Well, you are in luck. Because we promise it is not as hard as it seems. To make a quick and dirty version of our little chart, all it takes is an Excel spreadsheet.       
                </p>
                
                  <h3 style = 'color: black'>  Step 1: The Data</h3>
                 <p>
                    You can find the data <a href = 'https://github.com/vera-institute/incarceration_trends'> linked here </a> at the Vera Institute Github Page. What is GitHub, you ask? It is an open-source software where people can upload resources and collectively work on projects. Basically, your open-data ally. It is actually the powerhouse behind this website! If something is on GitHub, you are welcome and encouraged to download it and explore on your own. You want to click on the bottom file, incarceration_trends.xlsx, and download it. 
                </p>
            </section>          
        </div> 
        
         <img src = 'images/github_data.png'>      

        <div class="inner">  
             <br>
                <p>
                 When you open it up, you will see what may look like a pretty intimidating excel file. But we have all the tools we need to understand it.
                </p>
        </div>
        
                 <img src = 'images/open_excel_file.png'>      


        <div class="inner">  
             <br>
                <p>
                    Head back over to the Vera Institute Incarceration Trends GitHub page and scroll down through the project history until you find the heading <strong style = 'color: black'>Documentation</strong>. Click on the link that says <strong style = 'color: #6666FF'> Codebook </strong>. It should download a pdf for you. Scroll through that until you find the  <strong style = 'color: black'>Variables</strong> heading. We will use this to identify the information we want. 
                </p>
        </div>
        
                 <img src = 'images/github_information.png'>      
        
        <div class="inner">  
             <br>
                <p>
                    For our heatmap, we need three things. We need the State, we need the Year, and we need the Incarceration Rate which is the number of Incarcerated People per 100,000 residents between the ages of 15 and 64 living in the State. But if you look at the spreadsheet and the codebook, you will notice two problems. (1) All of the statistics are reported at the county level and (2) the data does not report the Incarceration Rate. So what can we do? Well, we know that we can, at a minimum, get Incarceration Rate at the county level from the number of incarcerated people and population of the state aged 15 to 64. So we are going to search the codebook for those two variables. It turns out that the number of people in jail in a county is represented by a variable called <strong> <i style = 'color: black'>total_jail_pop</i></strong> and the county population aged 15 to 64 is contained in a variable called <strong> <i style = 'color: black'>total_pop_15to64</i></strong>. Go ahead and click the plus sign at the bottom of the excel sheet to create a blank sheet then copy the columns for State, Year, population, and jail population over to the blank sheet. You can do that by clicking on the letter associated with the column at the top of the page and selecting copy from the menu. 
                </p>
        </div>
        
                         <img src = 'images/excel_copy_paste.png'>      

              <div class="inner">  
             <br>
                <p>
                   Your sheet should look like this:
                </p>
        </div>
                         <img src = 'images/new_sheet.png'>  
        
    </section>
    
    <section> 
        <div class="inner">  
            <br>
            <h3 style = 'color: black'>  Step 2: Some Quick Calculations</h3>
            <p>
             We have county-level population and jail population by year. But we want state-level numbers. We need to add up all the county numbers somehow. The first thing we are going to do is sort the data. Highlight all four of your columns, go to the data tab, and click the "Sort" button. In the dialogue box that appears, sort first by State and then by Year. 
            </p>
        </div>
        
         <img src = 'images/sorting_data.png'>  

        <div class="inner">  
            <br>
            <p>
           You will notice that there are some missing data points at the top. Unfortunately, Alaska is not very good about reporting jail populations at the county level! But we can handle that later. From here, we will use the Subtotal button to calculate subtotals for jail population and total population for each state and year. To do this, we need to apply the Subtotal button twice. The first time, we will calculate state subtotals. Highlight all four columns, note that you want calculations to occur at each change in state, you want to add a total for jail population and total population, and you want the summary below the data. Click okay, highlight the columns, and repeat the process. This time, you want to total by each change in year. Make sure that you DO NOT check the box that says <i> Replace current subtotals  </i>. Note this step might take alittle bit of time since excel does not always process large amounts of data quickly. 
            </p>
        </div>
        
        <img src = 'images/subtotals.png'>  
        
        
        <div class="inner">  
            <br>
            <p>
                Now that we have subtotals, you will notice two things. (1) The year subtotals are bolded and have the word "Total" written next to them – this will be useful later. (2) There are no values in the State column next to the year subtotals. We need to fix this issue before we can visualize the data. 
            </p>
        </div>
        
         <img src = 'images/showing_holes.png'>
        
        
        <div class="inner">  
            <br>
            <p>
                To accomplish this, we are going to create a new column called STATE in column E. Now we are going to use a formula to fill in the holes. We are going to use an IF formula and are going to say "If there is a hole, put the state from the row above into the hole. If there is not a hole, do not fill the cell". We type the formula in the first cell of the STATE column (cell E2) like this =IF(A2 = "", A1, ""). Then we go hover over cell E2 and double click on the little green square in the bottom right corner to expand that formula to the whole sheet. As a result, we should have state names only for the year total rows. 
                
            </p>
        </div>
        
         <img src = 'images/filling_holes.png'>
        
        
                <div class="inner">  
            <br>
            <p>
                Finally, we are ready for the last step of data preparation – calculating the incarceration rates for each state and year. To do this, we will use another formula. This one is very straight forward. Name column F Incarcaration. Then in the first cell, we are going to divide the total jail population by the state population and multiply by 100,000. It does not matter that there will be errors and that we will also be calculating county incarceration rates. We will filter those out at the very end. The formula should be as follows =C2/D2 *100000. Then, again, double click the green box in the corner of cell F2. The results should look as follows if you scroll down to Alabama. 
            </p>
        </div>
        
         <img src = 'images/rates_calculated.png'>
        
        
        
        
    </section>
        
    
    <section> 
        <div class="inner">  
            <br>
            <h3 style = 'color: black'>  Step 3: Visualizing the Data</h3>
            <p>
            Now we have calculated everything we need, so it is time to visualize our data. We are going to do this last bit with a pivot table. Unfortunately, the subtotals do not work too well with pivot tables. So first, create a new tab. Then highlight all of the columns, copy them over to the new sheet, then click on pivot table under insert and set it to open in yet another new sheet. 
            </p>
        </div>
        
        <img src = 'images/insert_pivot.png'>  


        
        <div class="inner">  
            <br>
            <p>
           A new sheet should open up with the pivot table tab available. In our heat map, we want states as rows and years as columns. So that is exactly what we are going to do. Click and drag those fields to the correct places. And we want to fill the cells with incarceration rate. So drag that field under the Values subheading. Finally, we want the incarceration value to display, not the count of values. So click on the (i) information symbole on the right side of the bar that says "Count of Incarceration" under Values. Then change the designation from Count to Sum. 
            </p>
        </div>
        
        <img src = 'images/pivot_set_up.png'>  
        
                
        <div class="inner">  
            <br>
            <p>
                Now, you will notice that only the years with "Total" after them display information. This is okay. To fix the chart, we just need to highlight the columns without the information displayed, right click, and hide them. We can also highlight the columns with the information we like and reduce their width to 2.5 for easier disply using the "Format" dropdown. 
            
            </p>
        </div>
        
        <img src = 'images/column_width.png'>  
        
        <div class="inner">  
            <br>
            <p>
               Our final step is to transform this mess of numbers into a picture by adding color. Highlight all of the cells with numbers in them, click on the "Conditional Formatting," go to "Color Scales" and choose the one you like. We prefer the scale where green is the lowest value and red is the highest since a higher incarceration rate is not a good thing.  
            </p>
        </div>
        
        
        <img src = 'images/add_color.png'>  
        
               <div class="inner">  
            <br>
            <p>
                And that is how you can make a quick and dirty heatmap out of incarceration data. This particular set required a bit of data cleaning. But if you have your own data set with places and time, it can be as simple as making a quick pivot table filled with your variable of interest and then using the conditional coloring command. 
                   
            </p>
        </div>
        
        <img src = 'images/final_product.png'>  
           
    </section>
        
        
    
<section> 
        <div class="inner">  
            <br>
            <h3 style = 'color: black'>  Step 4: Interpret Your Creation </h3>
            <p>
       Adding some interpretation to your work is important, particularly if you need to clarify data quality issues or limitations. In our case, Alaska, Connecticut, Delaware, Hawaii, Rhode Island, and Vermont all did not report county-level data to the set compiled by the Vera Institute. When we made our Incarceration Trends report, we were able to go through and gather State-Level data from the Vera Institute website. But we did that by hand. So here,  be careful not to assume that those states are just doing particularly well. Their data is just mising. You can just delete or hide those zeroes. 
            </p>

            <p>
                So now, whenever you have data to explore, think about making a heatmap out of it. You can find all of the resources for this analysis on our Github. And please feel free to contact us if you ever have any questions. 
            </p>
        </div>
        
       
           
    </section>
        
        
</section>   
    

<footer id="footer">

		<div class="copyright">
			Opening Data, Original Design: <a href="https://templated.co">TEMPLATED</a>
		</div>
        
</footer>
    
</body>
    

<script src ="https://d3js.org/d3.v5.min.js"></script>

    
<script>
   
    var mapsvg = d3.select("#figure1")
     .append("svg")
     .attr("preserveAspectRatio", "xMinYMin meet")
     .attr("viewBox", "0 0 750 680")
    .attr('id', 'heatmap')

var itemSize = 11,
      cellSize = itemSize - 0.85,
      margin = {top: 50, right: 50, bottom: 20, left: 100};
      
var width = 750 - margin.right - margin.left,
     height = 660 - margin.top - margin.bottom;

var colorScale = d3.scaleLinear()
        .domain([0,1, 100, 250, 750, 1250, 1750])
        .range(["#F8F8F8","rgb(226,238,249)", "rgb(42,166,137)", "rgb(253,213,61)", "rgb(226,148,33)", "rgb(238,94,50)","rgb(218,75,49)"]);
 
var data_abc;

var displayValue = "perc_pop";


function getData(){        
      d3.csv('incarceration_state_percentages_join.csv')
          .then( 
          function(response) {
                data_abc = response;
                draw(data_abc);  
                                });
}







function draw(input_data){

    
    data = input_data;
    
    var x_elements = d3.set(input_data.map(function( item ) { return item.year; } )).values(),
        y_elements = d3.set(input_data.map(function( item ) { return item.State; } )).values();

    var xScale = d3.scaleBand()
        .domain(x_elements)
        .range([0, x_elements.length * itemSize]);

    var xAxis = d3.axisTop()
        .scale(xScale)
        .tickFormat(function (d) {
            return d;
        });

    var yScale = d3.scaleBand()
        .domain(y_elements)
        .range([0, y_elements.length * itemSize]);

    var yAxis = d3.axisLeft()
        .scale(yScale)
        .tickFormat(function (d) {
            return d;
        });
    
   //     var svg = d3.select('#heatmap')
//        .append("text")
  //      .text("US Incarceration")
    //    .attr("transform", "translate(" + margin.left + "," +  margin.top + ")");
    
    var svg = d3.select('#heatmap')
        .append("g").attr("id","heat")
        .attr("transform", "translate(" + margin.left + "," +  margin.top + ")");

    var cells = svg.selectAll('rect').remove()
        .data(input_data)
        .enter()//.append('g')
        .append('rect')
        .attr('class', 'cell')
        .attr('width', cellSize)
        .attr('height', cellSize)
        .attr('y', function(d) { return yScale(d.State); })
        .attr('x', function(d) { return xScale(d.year); })
        .attr("id", function(d){return  d.State})
        .attr("class", function(d){return  d.Region})
        .style('fill', function(d) { return colorScale(d[displayValue]); })
  //  .on("mouseover", mouseover)
    //.on("mouseleave", mouseleave)
    //.on("click", mouseclickheat);

    svg.append("g").attr("id","heat")
        .attr("class", "y axis")
        .call(yAxis)
        .selectAll('text')
        .attr('font-weight', 'normal');

    svg.append("g").attr("id","heat")
        .attr("class", "x axis")
        .call(xAxis)
        .selectAll('text')
        .attr('font-weight', 'normal')
        .style("text-anchor", "start")
        .attr("dx", ".8em")
        .attr("dy", ".5em")
        .attr("transform", function (d) {
            return "rotate(-65)";
        });
           
var svgLegend = d3.select('#heatmap').append('g').attr("id","heat")
        .attr("transform", "translate(" + 95 + ","+ 580 + ")")
//.attr("preserveAspectRatio", "xMinYMin meet")
//     .attr("viewBox", "0 0 750 50")
// .attr("width", width)

;

var defs = svgLegend.append('defs');
var linearGradient = defs.append('linearGradient')
		.attr('id', 'linear-gradient');

    // horizontal gradient
linearGradient
  .attr("x1", "0%")
  .attr("y1", "0%")
  .attr("x2", "100%")
  .attr("y2", "0%");
    
// append multiple color stops by using D3's data/enter step
linearGradient.selectAll("stop")
  .data([
    {offset: "0%", color: "#F8F8F8"},
    {offset: "1%", color: "rgb(226,238,249)"},
    {offset: "5%", color: "rgb(42,166,137)"},
    {offset: "12.5%", color: "rgb(253,213,61)"},
    {offset: "37.5%", color: "rgb(226,148,33)"},
    {offset: "62.5%", color: "rgb(238,94,50)"},
        {offset: "87.5%", color: "rgb(218,75,49)"},

    {offset: "100%", color: "#00000"}
  ])
  .enter().append("stop")
  .attr("offset", function(d) { 
    return d.offset; 
  })
  .attr("stop-color", function(d) { 
    return d.color; 
  });
    
    
    // append title
svgLegend.append("text")
  .attr("class", "legendTitle")
  .attr("x", 10)
  .attr("y", 20)
  .style("text-anchor", "left")
    .style("font-size", "14px")
  .text("Incarcerated Individuals Per 100,000 Residents Ages 15-64");
    
    
    // draw the rectangle and fill with gradient
svgLegend.append("rect").attr("id", "heatlegend")
  .attr("x", 10)
  .attr("y", 30)
  .attr("width", 400)
  .attr("height", 15)
  .style("fill", "url(#linear-gradient)");
    
    
    //create tick marks
var xLeg = d3.scaleLinear()
  .domain([0, 250, 500, 1000,  1500, 2000])
  .range([0, 50, 100,200, 300, 390]);
    
    
    var axisLeg = d3.axisBottom(xLeg)
  .tickValues(xLeg.domain())
    
    
svgLegend
  .attr("class", "axis")
  .append("g").attr("id","heat")
  .attr("transform", "translate(10, 50)")
  .call(axisLeg);
    
   
//  handleResize();
    
    
};
    
    
    getData();
    
    
    </script>
    
</html>
               